# üïµÔ∏è‚Äç‚ôÇÔ∏è Context Handoff: Plex Channel Seeding & Playback Debugging

> **Status:** üü° **PARTIAL SUCCESS** (Seeding Fixed / Loop Dampened / Playback Blocked)
> **Current Blocker:** `400 Bad Request` from Plex Transcoder (`universal/start.m3u8`)
> **Priority:** üö® **HIGH** - Media playback is the core feature.
> **Role for Next Session:** **Staff Software Engineer / Plex API Specialist**

---

## üß† 1. Mission & Persona

**You are Antigravity (Level 5).**
You are not just fixing a bug; you are stabilizing the core media pipeline of the Retune application. You value **root cause analysis**, **defensive programming**, and **systemic fixes** over quick patches. You understand that HLS playback involves a delicate handshake between Client, Server, and Transcoder.

**Your Philosophy:**

1. **Trust No input:** Verify every parameter sent to the Transcoder.
2. **Fail Gracefully:** Infinite loops are unacceptable. Errors must be handled, logged, and backed off.
3. **Persist Cleanly:** `localStorage` is a dangerous state cache; handle it with versioning and sanitization.

---

## üèóÔ∏è 2. Architectural Context

### Component Data Flow

The data flows from Plex to the Video Player through these stages:

1. **`Orchestrator`** (`src/Orchestrator.ts`):
    * **Role:** The brain. Manages startup (`_runStartup`), channel seeding (`_seedDefaultChannels`), and scheduling (`_handleProgramStart`).
    * **Key State:** Currently has a **2-second artificial delay** in `_handleProgramStart` to dampen retry loops.

2. **`ChannelManager`** (`src/modules/scheduler/channel-manager/ChannelManager.ts`):
    * **Role:** Manages channel configurations and persistence.
    * **Key State:** Uses `localStorage` Key `retune_channels_v4`.

3. **`ContentResolver`** (`src/modules/scheduler/channel-manager/ContentResolver.ts`):
    * **Role:** Converts a Channel's `contentSource` into actual media items.
    * **Key Fix:** Now correctly receives `libraryId` instead of `value`.

4. **`PlexStreamResolver`** (`src/modules/plex/stream/PlexStreamResolver.ts`):
    * **Role:** Generates the playback URL.
    * **Current Hotspot:** `getTranscodeUrl()` method is generating the failing 400 URL.

5. **`VideoPlayer`** (`src/modules/player/VideoPlayer.ts`):
    * **Role:** The HTML5 Video Element wrapper. Uses native HLS (webOS).
    * **Behavior:** Emits `error` events which bubble up to Orchestrator.

---

## üìú 3. The Debugging Saga (History)

### Chapter 1: The "Zombie Channel" (RESOLVED ‚úÖ)

* **The Bug:** App crashed with `404 Not Found` for `.../sections/undefined/all`.
* **Root Cause:**
  * **Typo:** `Orchestrator` created channels with `{ value: "6" }` but `PlexLibrary` expected `{ libraryId: "6" }`.
  * **Persistence:** The invalid channel was saved to `localStorage`. Even after fixing the code, the app loaded the "broken" channel from storage (`v3` keys).
* **The Fix:**
    1. Corrected property names in `Orchestrator.ts`.
    2. Rotated storage keys to `retune_channels_v4` in `constants.ts` to force a factory reset.
    3. **Result:** Channels now seed correctly with valid IDs.

### Chapter 2: The Infinite Fast-Fail Loop (DAMPENED ‚ö†Ô∏è)

* **The Bug:** Upon failing to play (due to the 400 error below), the app entered a tight infinite loop (>1000 errors/sec).
* **Mechanism:** `VideoPlayer` Error -> `Orchestrator` Catch -> `Scheduler.skipToNext()` -> `ProgramStart` Event -> `VideoPlayer.load()` -> Error.
* **The Fix:** Added `await new Promise(r => setTimeout(r, 2000))` in `Orchestrator.ts` error handler.
* **Action:** **REMOVE** this delay once the 400 error is fixed to restore snappy user experience.

### Chapter 3: The 400 Bad Request (ACTIVE üî¥)

* **The Bug:** The generated HLS URL is rejected by Plex Server.
* **URL:** `.../video/:/transcode/universal/start.m3u8?...`
* **Status:** Active blocker.

---

## üî¨ 4. Deep Dive: The 400 Error Analysis

We have analyzed the URL parameters generated by `PlexStreamResolver.ts` against known Plex API requirements.

### Parameter Audit

| Parameter | Current Value | Expected / Best Practice | Risk Level |
| :--- | :--- | :--- | :--- |
| **`session`** | **MISSING** | **REQUIRED** for `universal/start`. Must allow the transcoder to track the session. | üö® **CRITICAL** |
| `X-Plex-Session-Identifier` | (UUID) | Should match `session`. | ‚úÖ OK |
| `path` | `/library/metadata/{id}` | Must be the exact key of the item trying to play. | ‚úÖ Likely OK |
| `mediaIndex` | `0` | The index of the media item (usually 0). | ‚úÖ OK |
| `partIndex` | `0` | The index of the file part (usually 0). | ‚úÖ OK |
| `offset` | **MISSING** | Should usually be `0` (or start time in seconds). | ‚ö†Ô∏è Medium |
| `fastSeek` | `1` | Some server versions reject this on initialization. | ‚ö†Ô∏è Medium |
| `X-Plex-Client-Profile-Extra` | (Complex String) | Defines codec capabilities. If malformed, causes 400. | ‚ö†Ô∏è Medium |
| `subtitles` | `burn` | Forces burning. Requires valid transcoding session. | ‚úÖ OK |

### Hypothesis

The **missing `session` query parameter** is the most likely cause. The Plex Universal Transcoder needs to link the `start.m3u8` request to a specific session ID to manage the segments. We are sending `X-Plex-Session-Identifier` (header/param) but missing the core `session` param often expected by the orchestrator.

---

## üõ†Ô∏è 5. Implementation Plan

### Phase 1: Fix the URL (`PlexStreamResolver.ts`)

Modify `getTranscodeUrl` to include the missing parameters and conform to best practices.

```typescript
// Proposed Change in PlexStreamResolver.ts
const params = new URLSearchParams({
    path: `/library/metadata/${itemKey}`,
    mediaIndex: '0',
    partIndex: '0',
    protocol: 'hls',
    offset: '0',                   // [NEW] Explicit offset
    session: sessionId,            // [NEW] Critical missing param
    'X-Plex-Session-Identifier': sessionId,
    // ... validation ...
});
```

### Phase 2: Verification

1. **Reload the App:** Warning: `localStorage` is on `v4`. You do NOT need to rotate keys again unless you change the *Channel* data structure.
2. **Check Logs:** Look for `200 OK` on `start.m3u8`.
3. **Visual Confirmation:** Video should start playing.

### Phase 3: Cleanup

1. **Remove Dampener:** Delete the `setTimeout` in `Orchestrator.ts`.
2. **Verify Retry Logic:** Ensure `RetryManager` eventually gives up (returns a fatal error) if the stream is truly 400/404, rather than looping forever.

---

## üìö 6. Reference Material

* **Plex API Unofficial Docs:** `universal/start` is the modern endpoint. Older clients used `transcode/session`.
* **WebOS Specifics:** WebOS supports HLS natively. We are using `protocol=hls` and `container=mpegts` which is correct.
* **Codecs:** Using `h264` and `aac` is the safest baseline for WebOS.

**Go forth and stream.**
